name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools safety

    - name: Check for outdated dependencies
      id: outdated
      run: |
        pip list --outdated > outdated_dependencies.txt
        cat outdated_dependencies.txt
        echo "::set-output name=count::$(wc -l < outdated_dependencies.txt)"
      continue-on-error: true

    - name: Run security audit
      run: |
        safety check --json > security_report.json || true
        safety check || true
      continue-on-error: true

    - name: Upload reports
      uses: actions/upload-artifact@v3
      with:
        name: dependency-reports
        path: |
          outdated_dependencies.txt
          security_report.json

    - name: Create issue for outdated dependencies
      if: steps.outdated.outputs.count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const outdated = fs.readFileSync('outdated_dependencies.txt', 'utf8');

          const issueBody = `
          ## Outdated Dependencies Report

          The following dependencies are outdated:

          \`\`\`
          ${outdated}
          \`\`\`

          **Actions Required:**
          1. Review the outdated packages
          2. Test updates in a feature branch
          3. Update \`requirements.txt\` if safe to upgrade
          4. Run full test suite

          **Generated by:** Dependency Check Workflow
          **Date:** ${new Date().toISOString()}
          `;

          // Check if issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies'
          });

          const existingIssue = issues.data.find(issue =>
            issue.title === 'Weekly Dependency Update Report'
          );

          if (existingIssue) {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: issueBody
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Weekly Dependency Update Report',
              body: issueBody,
              labels: ['dependencies', 'maintenance']
            });
          }
